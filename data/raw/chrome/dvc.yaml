vars:
  - ../../../params.yaml

stages:
  merge_response:
    foreach: ${browser_object}
    do:
      frozen: true
      wdir: ../../../
      cmd: >-
        python3 src/transformer/merge_jsons.py
        data/raw/${item.browser}/${item.date}
        data/merged/${item.browser}/${item.date}
        response
      deps:
        - src/transformer/merge_jsons.py
        - data/raw/${item.browser}/${item.date}
      outs:
        - data/merged/${item.browser}/${item.date}/merged_data_response.json.gz

  merge_request:
    foreach: ${browser_object}
    do:
      frozen: true
      wdir: ../../../
      cmd: >-
        python3 src/transformer/merge_jsons.py
        data/raw/${item.browser}/${item.date}
        data/merged/${item.browser}/${item.date}
        request
      deps:
        - src/transformer/merge_jsons.py
        - data/raw/${item.browser}/${item.date}
      outs:
        - data/merged/${item.browser}/${item.date}/merged_data_request.json.gz

  parse_to_parquet_response:
    foreach: ${browser_object}
    do:
      frozen: true
      wdir: ../../../
      cmd: >-
        python3 run_pipeline.py parse_raw_data.py
        ${item.browser}
        ${item.date}
        merged_data_response
        processed
        response
      deps:
        - run_pipeline.py
        - src/transformer/parse_raw_data.py
        - src/pipeline_functions/parse_raw_data_functions.py
        - data/merged/${item.browser}/${item.date}/merged_data_response.json.gz
      outs:
        - data/processed/${item.browser}/${item.date}/merged_data_response.parquet.gzip

  parse_to_parquet_request:
    foreach: ${browser_object}
    do:
      frozen: true
      wdir: ../../../
      cmd: >-
        python3 run_pipeline.py parse_raw_data.py
        ${item.browser}
        ${item.date}
        merged_data_request
        processed
        request
      deps:
        - run_pipeline.py
        - src/transformer/parse_raw_data.py
        - src/pipeline_functions/parse_raw_data_functions.py
        - data/merged/${item.browser}/${item.date}/merged_data_request.json.gz
      outs:
        - data/processed/${item.browser}/${item.date}/merged_data_request.parquet.gzip

  train_test_split:
    frozen: true
    wdir: ../../../
    cmd: >-
      python3 run_pipeline.py train_test_split.py
      ${browsers.chrome}
      ${dir_name.date_one}
      merged_data
    deps:
      - src/transformer/train_test_split.py
      - src/pipeline_functions/train_test_split_functions.py
      - data/processed/${browsers.chrome}/${dir_name.date_one}/merged_data.parquet.gzip
    outs:
      - data/processed/${browsers.chrome}/${dir_name.date_one}/train_set.parquet.gzip
      - data/processed/${browsers.chrome}/${dir_name.date_one}/test_set.parquet.gzip
#      - data/processed/${browsers.chrome}/${dir_name.date_one}/validation_set.parquet.gzip
      - data/processed/${browsers.chrome}/${dir_name.date_one}/calibration_set.parquet.gzip

  pre_processing_train_set:
    frozen: true
    wdir: ../../../
    cmd: >-
      python3 run_pipeline.py data_preprocessing_config.py 
      ${browsers.chrome}
      ${dir_name.date_one}
      train_set
      preprocessing_config.json
      False
    deps:
      - run_pipeline.py
      - src/pipeline_functions/data_preprocessing_functions.py
      - src/transformer/data_preprocessing_config.py
      - data/processed/${browsers.chrome}/${dir_name.date_one}/train_set.parquet.gzip
    outs:
      - data/processed/${browsers.chrome}/${dir_name.date_one}/train_set_processed.parquet.gzip
      - preprocessing_config.json

  pre_processing_other_sets:
    foreach: ${browser_object_parsed}
    do:
      frozen: true
      wdir: ../../../
      cmd: >-
        python3 run_pipeline.py data_preprocessing_config.py 
        ${item.browser}
        ${item.date}
        ${item.file_name}
        preprocessing_config.json
        ${item.other_data_set_bool}
      deps:
        - run_pipeline.py
        - src/pipeline_functions/data_preprocessing_functions.py
        - src/transformer/data_preprocessing_config.py
        - data/processed/${item.browser}/${item.date}/${item.file_name}.parquet.gzip
        - preprocessing_config.json
      outs:
        - data/processed/${item.browser}/${item.date}/${item.file_name}_processed.parquet.gzip

  feature_engineering:
    foreach: ${browser_object_feature_engineering}
    do:
      frozen: true
      wdir: ../../../
      cmd: >-
        python3 run_pipeline.py feature_engineering.py
        ${item.browser}
        ${item.date}
        ${item.file_name}
        binary_encoding
      deps:
        - run_pipeline.py
        - src/features/feature_engineering.py
        - src/pipeline_functions/feature_engineering_functions.py
        - data/processed/${item.browser}/${item.date}/${item.file_name}_processed.parquet.gzip
      outs:
        - data/processed/${item.browser}/${item.date}/${item.file_name}_featurized_BE.parquet.gzip

  model_training:
    frozen: true
    wdir: ../../../
    cmd: >-
      python3 run_pipeline.py train_model.py
      ${browsers.chrome}
      ${dir_name.date_one}
      train_set_featurized_BE
      binary
      chrome_old_BE
    deps:
      - src/models/train_model.py
      - data/processed/${browsers.chrome}/${dir_name.date_one}/train_set_featurized_BE.parquet.gzip
    outs:
      - models/result_metrics/chrome_old_BE.csv
      - ${dir_paths.chrome_old_models}/Logistic_Regression_BE.sav.gz
      - ${dir_paths.chrome_old_models}/Gaussian_NB_BE.sav.gz
      - ${dir_paths.chrome_old_models}/Bernoulli_NB_BE.sav.gz
      - ${dir_paths.chrome_old_models}/Decision_Tree_BE.sav.gz
      - ${dir_paths.chrome_old_models}/Random_Forest_BE.sav.gz
      - ${dir_paths.chrome_old_models}/Extra_Trees_Classifier_BE.sav.gz
      - ${dir_paths.chrome_old_models}/Ada_Boost_BE.sav.gz
      - ${dir_paths.chrome_old_models}/Gradient_Boosting_BE.sav.gz
      - ${dir_paths.chrome_old_models}/LightGBM_BE.sav.gz
      - ${dir_paths.chrome_old_models}/Hist_GB_BE.sav.gz
      - ${dir_paths.chrome_old_models}/XGBoost_BE.sav.gz

  model_evaluation:
    foreach: ${browser_object_evaluation}
    do:
      frozen: true
      wdir: ../../../
      cmd: >-
        python3 run_pipeline.py test_model.py
        ${item.browser}
        ${item.date}
        ${item.file_name}
      deps:
        - run_pipeline.py
        - src/models/test_model.py
        - ${dir_paths.chrome_old_models}/Logistic_Regression_BE.sav.gz
        - ${dir_paths.chrome_old_models}/Gaussian_NB_BE.sav.gz
        - ${dir_paths.chrome_old_models}/Bernoulli_NB_BE.sav.gz
        - ${dir_paths.chrome_old_models}/Decision_Tree_BE.sav.gz
        - ${dir_paths.chrome_old_models}/Random_Forest_BE.sav.gz
        - ${dir_paths.chrome_old_models}/Extra_Trees_Classifier_BE.sav.gz
        - ${dir_paths.chrome_old_models}/Ada_Boost_BE.sav.gz
        - ${dir_paths.chrome_old_models}/Gradient_Boosting_BE.sav.gz
        - ${dir_paths.chrome_old_models}/LightGBM_BE.sav.gz
        - ${dir_paths.chrome_old_models}/Hist_GB_BE.sav.gz
        - ${dir_paths.chrome_old_models}/XGBoost_BE.sav.gz
        - data/processed/${item.browser}/${item.date}/${item.file_name}_featurized_BE.parquet.gzip
      outs:
        - models/result_metrics/${item.browser}_${item.date}_${item.file_name}.csv
        - models/result_metrics/${item.browser}_${item.date}_${item.file_name}_CI.csv
